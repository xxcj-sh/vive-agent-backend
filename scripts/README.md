# 用户数据管理脚本

## 功能概述
这个脚本用于安全地删除用户及其所有关联数据，包括：
- 用户卡片信息
- 匹配记录
- 聊天记录
- 聊天会话
- 用户账户

## 使用方法

### 1. 列出所有用户
```bash
python manage_user_data.py --list-users
```

### 2. 通过用户ID删除用户（模拟模式）
```bash
python manage_user_data.py --user-id "user-uuid-here" --dry-run --verbose
```

### 3. 通过手机号删除用户（实际删除）
```bash
python manage_user_data.py --phone "13800138000"
```

### 4. 实际删除用户（无模拟）
```bash
python manage_user_data.py --user-id "user-uuid-here"
```

## 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `--user-id` | 用户UUID | `--user-id "550e8400-e29b-41d4-a716-446655440000"` |
| `--phone` | 用户手机号 | `--phone "13800138000"` |
| `--dry-run` | 模拟删除，不实际删除数据 | `--dry-run` |
| `--verbose` | 显示详细信息 | `--verbose` |
| `--list-users` | 列出所有用户 | `--list-users` |

## 删除顺序

脚本会按以下顺序安全删除数据：

1. **聊天记录** - 删除用户发送和接收的所有消息
2. **聊天会话** - 删除用户参与的所有会话
3. **用户卡片** - 删除用户的所有角色卡片
4. **匹配记录** - 删除用户的所有匹配记录
5. **用户账户** - 最后删除用户账户本身

## 安全特性

- **事务支持** - 所有删除操作在一个事务中执行，失败时自动回滚
- **外键约束处理** - 正确处理数据库外键约束，避免删除失败
- **数据验证** - 删除前验证用户存在性和数据量
- **模拟模式** - 支持dry-run模式预览删除结果

## 示例输出

### 模拟删除
```
=== 用户数据统计 ===
用户ID: 550e8400-e29b-41d4-a716-446655440000
手机号: 13800138000
昵称: 测试用户
用户卡片: 3
匹配记录: 5
发送消息: 12
接收消息: 8
聊天会话: 3

=== 删除结果 ===
用户: 13800138000
昵称: 测试用户

[模拟删除] 数据量统计:
  user_cards: 3
  matches: 5
  chat_messages: 20
  chat_conversations: 3
  user_account: 1

这是模拟删除，实际数据未删除
```

### 实际删除
```
=== 删除结果 ===
用户: 13800138000
昵称: 测试用户

[实际删除] 已删除数据:
  user_cards: 3
  matches: 5
  chat_messages: 20
  chat_conversations: 3
  user_account: 1

用户数据已成功删除
```

## 注意事项

1. **不可恢复** - 删除操作不可撤销，请谨慎使用
2. **备份建议** - 执行删除前建议备份数据库
3. **权限要求** - 需要数据库写入权限
4. **生产环境** - 在生产环境使用前请先在测试环境验证