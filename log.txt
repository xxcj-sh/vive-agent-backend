社群标签功能开发日志
========================

开发时间: 2026-02-01
功能模块: 社群标签、邀请系统、内容推送

一、实现的功能
------------------------
1. 社群标签创建
   - 支持创建 user_community 类型标签
   - 支持设置最大成员数、公开/私有属性
   - 标签创建者管理功能

2. 社群邀请系统
   - 创建邀请码（支持设置使用次数、过期时间）
   - 使用邀请码加入社群
   - 邀请使用记录追踪
   - 邀请管理和取消功能

3. 标签内容推送
   - 创建和发布标签关联内容
   - 支持多种内容类型（card/topic/article/link）
   - 根据用户标签推荐个性化内容
   - 内容交互统计（浏览、点赞、分享）

二、遇到的问题及解决方案
------------------------
1. f-string 语法错误
   - 问题: 在 tag_service.py 中使用了复杂的条件表达式在 f-string 中
   - 位置: 第1251行
   - 解决: 使用 action_map 字典预先计算操作名称，避免 f-string 中使用条件表达式

2. datetime 模块未导入
   - 问题: TagService 类中使用了 datetime 但未导入
   - 解决: 在文件顶部添加 `from datetime import datetime`

3. SQLAlchemy 关系定义错误
   - 问题: Tag 和 CommunityInvitation 之间没有外键约束
   - 错误信息: "Could not determine join condition between parent/child tables"
   - 解决: 
     - 在 CommunityInvitation.tag_id 添加 ForeignKey('tags.id', ondelete='CASCADE')
     - 在 InvitationUsage.invitation_id 添加 ForeignKey('community_invitations.id', ondelete='CASCADE')
     - 更新相关 relationship 定义

4. JSON 字段索引问题
   - 问题: MySQL JSON 字段不支持直接创建索引
   - 解决: 移除 tag_contents 表的 idx_content_tag_ids 索引

5. 重复导入问题
   - 问题: 存在冗余的局部导入语句
   - 解决: 将所有必要的模型和枚举在文件顶部统一导入，移除方法内部的重复导入

三、数据库变更
------------------------
新增表:
- community_invitations: 社群邀请表
- invitation_usage: 邀请使用记录表
- tag_contents: 标签推送内容表
- content_tag_interactions: 内容交互记录表

四、API 接口列表
------------------------
社群标签:
- POST /api/v1/tags - 创建标签
- GET /api/v1/tags - 获取标签列表
- GET /api/v1/tags/{tag_id} - 获取标签详情
- PUT /api/v1/tags/{tag_id} - 更新标签
- DELETE /api/v1/tags/{tag_id} - 删除标签

社群邀请:
- POST /api/v1/community/invitations - 创建邀请码
- GET /api/v1/community/invitations/my - 获取我创建的邀请
- GET /api/v1/tags/{tag_id}/invitations - 获取标签的邀请列表
- POST /api/v1/community/invitations/{id}/cancel - 取消邀请
- POST /api/v1/community/invitations/redeem - 使用邀请码

标签内容:
- POST /api/v1/contents - 创建内容
- POST /api/v1/contents/{id}/publish - 发布内容
- GET /api/v1/tags/{tag_id}/contents - 获取标签内容
- GET /api/v1/contents/recommend - 根据标签获取推荐内容
- GET /api/v1/contents/re/mycommend - 获取个性化推荐内容
- GET /api/v1/contents/{id} - 获取内容详情
- POST /api/v1/contents/{id}/interact - 内容交互

五、待完善事项
------------------------
1. 微信小程序分享链接集成
2. 注册自动获得社群标签的回调机制
3. 前端页面开发

六、前端页面开发（2026-02-01）
------------------------
1. 我的页面悬浮按钮扩展
   - 在标签Tab（currentTab === 'identity'）显示创建悬浮按钮
   - 点击跳转到社群标签创建页面

2. 社群标签页面创建模式
   - 支持 mode=create 参数进入创建模式
   - 添加创建表单（名称、描述、图标、最大成员数、公开/私有）
   - 调用 TagAPI.createTag 创建社群标签
   - 创建成功后自动返回上一页

七、修改的文件列表
------------------------
前端（vive-agent-frontend）:
- pages/mine/mine.wxml - 悬浮按钮显示逻辑
- pages/mine/mine.js - 添加 navigateToCreateCommunityTag 方法
- package-tag/pages/community-tag/community-tag.js - 支持创建模式
- package-tag/pages/community-tag/community-tag.wxml - 添加创建表单UI
- package-tag/pages/community-tag/community-tag.wxss - 添加创建表单样式

后端（vive-agent-backend）:
- app/models/community_invitation.py - 添加外键约束
- app/services/tag_service.py - 清理冗余导入、创建标签时自动加入创建者

八、问题修复（2026-02-01）
------------------------
1. 社群标签创建后不显示问题
   - 问题: 创建社群标签后，在"我的标签"页面看不到创建的标签
   - 原因: create_tag 方法只创建标签记录，没有自动将创建者加入标签
   - 解决: 在 create_tag 方法中添加代码，自动创建 UserTagRel 记录将创建者加入标签

九、前端UI优化（2026-02-01）
------------------------
1. 社群标签分组展示
   - 在我的页面底部标签区域，分别展示"我创建的社群"和"我加入的社群"
   - 我创建的社群：使用青色渐变背景
   - 我加入的社群：使用紫色渐变背景以区分
   - 添加分组标题和数量统计
   - 每个分组最多显示5个标签
   - 支持查看更多功能

2. 问题修复
   - 修复 community-tag.js 中 LoginGuide.getUserProfile 方法不存在的问题
   - 改用 apiService.getUserInfo() 获取用户信息
